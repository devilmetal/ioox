/* ***** BEGIN LICENSE BLOCK *****
 *
 * Copyright (C) 2012 S. Sire
 *
 * This file contains files from the AXEL-FORMS extension to the Adaptable XML Editing Library (AXEL)
 * Version 0.1
 *
 * AXEL-FORMS is licensed by Oppidoc SARL 
 *
 * Web site : http://www.oppidoc.fr, https://bitbucket.org/ssire/axel-forms
 * 
 * Contributors(s) : S. Sire
 * 
 * ***** END LICENSE BLOCK ***** */
 (function(g){function c(n,o,p,q){var l=$(o),m;this.doc=p;this.axelPath=q;this.key=n;this.templateUrl=l.attr("data-template");this.dataUrl=l.attr("data-src");this.cancelUrl=l.attr("data-cancel");this.transaction=l.attr("data-transaction");this.spec=l;if(this.templateUrl){if(this.templateUrl!=="#"){m=this.templateUrl.substring(this.templateUrl.lastIndexOf("/")+1);if(m.indexOf("?")!==-1){m=m.substring(0,m.indexOf("?"))}$("body",p).addClass("edition").addClass(m)}this.initialize();if(this.cancelUrl){$(window).bind("unload",$.proxy(this,"reportCancel"))}}else{g.command.logError('Missing data-template attribute to generate the editor "'+this.key+'"')}$(p).triggerHandler("AXEL-TEMPLATE-READY",[this])}c.prototype={attr:function(l){return this.spec.attr(l)},initialize:function(){var l=new xtiger.util.Logger(),n,o,m;if(this.templateUrl==="#"){n=this.doc}else{n=xtiger.debug.loadDocument(this.templateUrl,l)}if(n){this.form=new xtiger.util.Form(this.axelPath);this.form.setTemplateSource(n);if(n!==this.doc){this.form.setTargetDocument(this.doc,this.key,true)}this.form.enableTabGroupNavigation();this.form.transform(l);if(this.dataUrl){o=xtiger.cross.loadDocument(this.dataUrl,l);if(o){if($("error > message",o).size()>0){g.command.logError($("error > message",o).text())}else{m=new xtiger.util.DOMDataSource(o);this.form.loadData(m,l)}}}}if(l.inError()){g.command.logError(l.printErrors())}},reset:function(){var l=new xtiger.util.Logger();if(this.form){this.form.transform(l)}if(l.inError()){g.command.logError(l.printErrors())}},serializeData:function(){var l,m;if(this.form){l=new xtiger.util.DOMLogger();this.form.serializeData(l);m=l.dump()}return m},reportCancel:function(l){if(!this.hasBeenSaved){$.ajax({url:this.cancelUrl,data:{transaction:this.transaction},type:"GET",async:false})}}};var h=0,j=0;var a={};var e={};var b={};var k={configure:function(l,m){b[l]=m},logError:function(n,m){var l=m?$(m):undefined;if(l&&(l.length>0)){l.text(n)}else{if(typeof b.logError==="function"){b.logError(n)}else{alert(n)}}},register:function(n,m,o){var l={factory:m};if(o){g.extend(l,o)}a[n]=l},getEditor:function(l){return e[l]}};function i(n,o,p){var m=$(n).attr("id")||("untitled"+(h++)),l=new c(m,n,o,p);e[m]=l;return l}function f(o,p){var n=$(o).attr("data-command"),m=$(o).attr("data-target")||("untitled"+(j++)),l=a[n];if(l){if(l.check){if(g.command.getEditor(m)){if(o.disabled){o.disabled=false}new a[n].factory(m,o,p)}else{o.disabled=true;g.command.logError("Missing or invalid data-target attribute in "+n+' command ("'+m+'")')}}else{new a[n].factory(m,o,p)}}else{g.command.logError('Attempt to create an unkown command "'+n+'"')}}function d(m){var o=$("script[data-bundles-path]").attr("data-bundles-path"),l=$("div[data-template]",m).add('body[data-template="#"]',m),n=[];if(o){g.filter.applyTo({optional:"input",event:"input"})}if(l.length>0){if(o||b.axelPath){l.each(function(q,p){n.push(i(p,m,o||b.axelPath))})}else{g.command.logError("Cannot start editing because AXEL library path is unspecified")}}$("*[data-command]",m).each(function(q,p){f(p,m)});if(o){g.binding.install(document)}return n}g.command=k;g.command.install=d;jQuery(function(){d(document)})}($axel));(function(h){var a={};var j={getDocument:function(){return this._doc},getParam:function(k){return this._param[k]||this._defaults[k]},getVariable:function(){return this._variable}};var c={_installError:function(k){this.errScope=k.attr("data-error-scope")||undefined;this.errSel="[data-"+this.getName()+'-error="'+this.getVariable()+'"]'},toggleError:function(n,l){var k,m,o=this.getDocument();if(!this.errScope){k=$("body "+this.errSel,o)}else{if(l){m=$(l,o).closest(this.errScope);k=$(this.errSel,m.get(0))}}if(k){if(n){k.hide()}else{k.show()}}return n}};function d(n,m,l){var k=new Function();k.prototype=(function(o){var p=o;return{getName:function(){return p}}}(n));h.extend(k.prototype,j);if(m&&m.error){h.extend(k.prototype,c)}k.prototype.onInstall=l.onInstall;h.extend(k.prototype,l.methods,false,true);return k}function g(k,l,p){var o="#"+l,n=[],m=[];k.apply(function(r){var q;if((r.getParam("required")==="true")&&(!r.isModified())){q=$(r.getHandle()).parent().children(".label").text();n.push(q.substr(0,q.indexOf(":")-1));$(r.getHandle()).css("backgroundColor","pink")}else{if(r.isValid&&(!r.isValid())){q=$(r.getHandle()).parent().children(".label").text();m.push(q.substr(0,q.indexOf(":")-1));$(r.getHandle()).css("backgroundColor","yellow")}else{$(r.getHandle()).css("backgroundColor","")}}});$(o,p).html("");if(n.length>0){$(o,p).append("<p>Vous devez remplir les champs suivants : "+n.join(", ")+"</p>")}if(m.length>0){$(o,p).append("<p>Vous devez corriger les champs suivants : "+m.join(", ")+"</p>")}return(n.length===0)&&(m.length===0)}function b(l,k){if(l){if(typeof l.isValid==="function"){l.isValid.extend(k)}else{l.isValid=function(n){var o=[n];var m=function(){var q,p=true;for(var q=0;q<o.length;q++){p=p&&o[q](this)}return p};m.extend=function(p){o.push(p)};return m}(k)}}else{xtiger.cross.log("error","attempt to set a validator function on an undefined editor")}}function i(n,m,o,q){var p={},l=d(n,m,q);h.extend(p,o);a[n]={name:n,options:m,defaults:p,klass:l}}function e(t,u,q){var n,o,m,s,l={},p=true;var r=u.attr("data-variable");if(r){m=t.defaults;for(n in m){if(m.hasOwnProperty(n)){s=u.attr("data-"+n);if(s){l[n]=s}else{if(m[n]===h.binding.REQUIRED){xtiger.cross.log("error",'Missing attribute "data-'+n+'" to install "'+t.name+'" binding');p=false;break}}}}if(p){o=new t.klass();o._doc=q;o._variable=r;o._defaults=m;o._param=l;if(t.options&&t.options.error){o._installError(u)}o.onInstall(u);xtiger.cross.log("debug",'installed binding "'+t.name+'"');return o}}else{xtiger.cross.log("error",'Missing attribute "data-variable" to install "'+t.name+'" binding')}}function f(n,k,m){var o=k||n,l=k?"[data-binding]":"body [data-binding]";xtiger.cross.log("debug","installing bindings "+(k?"slice mode":"document mode"));do{$(l,o).each(function(p,t){var q,r=$(t),s=r.attr("data-binding").split(" ");for(q=0;q<s.length;q++){if(a[s[q]]){xtiger.cross.log("debug",'installing binding "'+s[q]+'"');e(a[s[q]],r,n)}else{xtiger.cross.log("error",'unregistered binding "'+s[q]+'"')}}});o=k?o.nextSibling:undefined}while(o&&(o!==m))}h.binding=h.binding||{};h.binding.list=function(){var k,l=[];for(k in a){l.push(k)}return l};h.binding.register=i;h.binding.install=f;h.binding.validate=g;h.binding.setValidation=b;h.binding.REQUIRED=1}($axel));(function(a){var c=function(g,f,d){var e=xtdom.createElement(d,"select");g.appendChild(e);return e};var b=(function(){function e(g){var f;if(g.indexOf("\\ ")===-1){return g.split(" ")}else{f=g.replace(/\\ /g,"&nbsp;");return xtiger.util.array_map(f.split(" "),function(h){return h.replace(/&nbsp;/g," ")})}}function d(j,f,n){var h,m,g,k=j.getHandle(),l=j.getDocument();for(h=0;h<f.length;h++){m=xtdom.createElement(l,"option");g=xtdom.createTextNode(l,n[h]);xtdom.setAttribute(m,"value",f[h]);m.appendChild(g);k.appendChild(m)}}return{onInit:function(j,g,h){var i,f=this.getParam("values");if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}if(!h){d(this,this.getParam("values"),this.getParam("i18n"))}this._setData(j)},onAwake:function(){var f=this;xtdom.addEventListener(this._handle,"change",function(h){var i=xtdom.getSelectedOpt(f.getHandle()),g=f.getParam("values");f.update(g[i])},true)},onLoad:function(i,g){var f,h;if(i!==-1){f=g.getDataFor(i);h=this.getDefaultData();if(f){this._setData(f)}else{this._setData(h)}this.set(false);this.setModified(f!==h)}else{this.clear(false)}},onSave:function(f){if((!this.isOptional())||this.isSet()){if(this._data!=="---"){f.write(this._data)}}else{f.discardNodeIfEmpty()}},api:{_parseFromTemplate:function(h){var i,g;this._param={};xtiger.util.decodeParameters(h.getAttribute("param"),this._param);g=xtdom.extractDefaultContentXT(h);i=h.getAttribute("option");this._option=i?i.toLowerCase():null;var f=h.getAttribute("values"),l=h.getAttribute("i18n"),k=f?e(f):["undefined"],j=l?e(l):undefined;if(!g){k.splice(0,0,"---");if(j){j.splice(0,0,"---")}g="---"}this._param.values=k;this._param.i18n=j||k;this._content=g},isFocusable:function(){return true}},methods:{_setData:function(h,j){var g,f=this.getParam("values");this._data=h;if(!j){for(g=0;g<f.length;g++){if(h===f[g]){xtdom.setSelectedOpt(this.getHandle(),g)}}}},dump:function(){return this._data},update:function(f){this._setData(f,true);this.setModified(f!==this.getDefaultData());this.set(true)},clear:function(f){this._setData(this.getDefaultData());if(this.isOptional()){this.unset(f)}}}}}());a.plugin.register("choice",{filterable:true,optional:true},{choice:"value"},c,b)}($axel));(function(i){var h=function(o,m,l){var k=xtdom.createElement(l,"input"),n=m.getAttribute("param");if(n){if(n.indexOf("type=radio")!==-1){xtdom.setAttribute(k,"type","radio")}else{if(n.indexOf("type=checkbox")!==-1){xtdom.setAttribute(k,"type","checkbox")}}}o.appendChild(k);return k};var j={};var a={};var f=function(n,k,l){var m=n.getHandle();this._editor=n;this.isEditable=!n.getParam("noedit");this.defaultData=l||"";xtdom.setAttribute(m,"type",k);m.value=this.defaultData};var g=function g(k,l){if(!j[k]){j[k]={}}j[k][l]=true};var b=function b(k,l){if(j[k]&&j[k][l]){delete j[k][l];return true}return false};var c=function(m,l){var n=parseInt(l),k=((n===0)||(isNaN(n)))?1:n;if(a[m]===undefined){a[m]=0}else{a[m]+=1}return Math.floor(a[m]/k)};f.prototype={awake:function(){var k=this._editor.getHandle();var l=this;if(this.isEditable){xtdom.addEventListener(k,"focus",function(m){if(!l.isEditing()){l.startEditing(m)}xtdom.stopPropagation(m);xtdom.preventDefault(m)},true);xtdom.addEventListener(k,"click",function(m){if(!l.isEditing()){l.startEditing(m)}xtdom.stopPropagation(m);xtdom.preventDefault(m)},true);xtdom.addEventListener(k,"mouseup",function(m){xtdom.stopPropagation(m);xtdom.preventDefault(m)},true);xtdom.addEventListener(k,"blur",function(m){if(l.isEditing()){l.stopEditing(false,true)}},true)}},isFocusable:function(){return(this.isEditable&&((!this._editor.isOptional())||this._editor.isSet()))},isEditing:function(){return this._isEditing},doKeyDown:function(k){},doKeyUp:function(k){},focus:function(){this._editor.getHandle().focus();this.startEditing()},unfocus:function(){this.stopEditing()},load:function(n,l){var k,m;if(n!==-1){k=l.getDataFor(n);m=this._editor.getDefaultData();this._editor.getHandle().value=k||m||"";this._editor.setModified(k!==m);this._editor.set(false)}else{this._editor.clear(false)}},save:function(k){var l=this._editor.getHandle().value;if(l){k.write(l)}},startEditing:function(l){var k,m=xtiger.session(this._editor.getDocument()).load("keyboard");if(!this._isEditing){k=this._editor.getHandle();this._legacy=k.value;this._isEditing=true;this.kbdHandlers=m.register(this,k);m.grab(this,this._editor);if(!this._editor.isModified()){xtdom.focusAndSelect(k)}}},stopEditing:function(k,n){var l=this._editor.getHandle();var m=xtiger.session(this._editor.getDocument()).load("keyboard");if(this._isEditing){this._isEditing=false;m.unregister(this,this.kbdHandlers,l);m.release(this,this._editor);if(!k){this._editor.update(l.value)}if((!n)&&(l.blur)){l.blur()}}},cancelEditing:function(){this._editor.getHandle().value=this._legacy;this.stopEditing()},clear:function(){this._editor.getHandle().value=this.defaultData},update:function(k){if(k===this._legacy){return}if(k.search(/\S/)===-1||(k===this._defaultData)){this._editor.clear(true)}else{this._editor.setModified(k!==this.defaultData);this._editor.set(true)}}};var e=function(p,k,n){var o=p.getHandle(),m=p.getParam("name"),l=p.getParam("cardinality");this._editor=p;this._type=k;if(m||(k==="radio")){if(l){n=c(m||"void",l).toString()}m=(m||"").concat(n||"");xtdom.setAttribute(o,"name",m);xtiger.cross.log("debug","Created input type "+k+" name="+m)}if(p.getParam("checked")==="true"){xtdom.setAttribute(o,"checked",true)}};e.prototype={awake:function(){var k=this._editor.getHandle();var l=this;xtdom.addEventListener(k,"click",function(m){if(l._editor.getHandle().checked){l._editor.update(l._editor.getParam("value"))}else{l._editor.update("")}},true)},isFocusable:function(){return false},load:function(o,n){var m,l,k=false;l=this._editor.getParam("value");if(-1!==o){m=n.getDataFor(o);k=(m===l);if(!k){name=this._editor.getParam("name");if(name){k=b(name,l);g(name,m)}}if(k){if(!this._editor.getHandle().checked){this._editor.getHandle().checked=true;this._editor.set(false)}}else{this._editor.clear(false)}}else{xtiger.cross.log("debug","aPoint is -1");name=this._editor.getParam("name");if(name){k=b(name,l)}if(k){if(!this._editor.getHandle().checked){this._editor.getHandle().checked=true;this._editor.set(false)}}else{this._editor.clear(false)}}},save:function(k){if(this._editor.getHandle().checked){k.write(this._editor.getParam("value"))}else{k.discardNodeIfEmpty()}},update:function(k){},clear:function(){this._editor.getHandle().checked=false}};var d={onInit:function(o,k,m){var l,n;l=this.getParam("type");if((l==="text")||(l==="password")){this._delegate=new f(this,l,o)}else{if((l==="radio")||(l==="checkbox")){this._delegate=new e(this,l,m?m.getClockCount():undefined)}else{xtdom.addClassName(this._handle,"axel-generator-error");xtdom.setAttribute(this._handle,readonly,"1");xtdom.setAttribute(this._handle,value,'ERROR: type "'+l+'" not recognized by plugin "input"')}}if(this.getParam("hasClass")){xtdom.addClassName(this._handle,this.getParam("hasClass"))}},onAwake:function(){this._delegate.awake()},onLoad:function(l,k){this._delegate.load(l,k)},onSave:function(k){if(this.isOptional()&&!this.isSet()){k.discardNodeIfEmpty()}else{this._delegate.save(k)}},api:{isFocusable:function(){return this._delegate.isFocusable()},focus:function(){if(this._delegate.focus){this._delegate.focus()}},unfocus:function(){if(this._delegate.focus){this._delegate.unfocus()}}},methods:{dump:function(){return this._delegate.dump()},update:function(k){this._delegate.update(k)},clear:function(k){this._delegate.clear();this.setModified(false);if(this.isOptional()&&this.isSet()){this.unset(k)}},set:function(k){if(k){if(!this.getParam("noedit")){xtiger.editor.Repeat.autoSelectRepeatIter(this.getHandle())}xtdom.removeClassName(this._handle,"axel-repeat-unset")}if(!this._isOptionSet){this._isOptionSet=true;if(this._isOptional){this._handle.disabled=false;this._optCheckBox.checked=true}}},unset:function(k){if(this._isOptionSet){this._isOptionSet=false;if(this._isOptional){this._handle.disabled=true;this._optCheckBox.checked=false}}}}};i.plugin.register("input",{filterable:true,optional:true},{type:"text"},h,d)}($axel));(function(a){var b={onInstall:function(c){this.terms=this.getParam("blacklist").split(" ");this.editor=a(c);c.bind("axel-update",$.proxy(this.filter,this));a.binding.setValidation(this.editor.get(0),$.proxy(this.filter,this))},methods:{filter:function(){var c,e=this.editor.text(),d=true;for(c=0;c<this.terms.length;c++){if(e===this.terms[c]){d=false;break}}return this.toggleError(d,this.editor.get(0).getHandle(true))}}};a.binding.register("blacklist",{error:true},{blacklist:a.binding.REQUIRED},b)}($axel));(function(a){var b={onInstall:function(d){var c=$('[data-clear="'+this.getVariable()+'"]',this.getDocument());this.editors=a(d);this.ui=c;c.bind("click",$.proxy(this,"execute"));d.bind("axel-update",$.proxy(this,"update"));d.bind("axel-select-all",$.proxy(this,"update"));c.hide()},methods:{execute:function(){this.editors.clear(false);this.ui.hide()},update:function(){var c=this.editors.text();if(c.length>0){this.ui.show()}else{this.ui.hide()}}}};a.binding.register("clear",null,null,b)}($axel));(function(a){var b={onInstall:function(c){this.avoidstr="data-avoid-"+this.getVariable();this.editor=a(c);c.bind("axel-update",$.proxy(this.updateConditionals,this))},methods:{updateConditionals:function(f,e){var g=this.editor.text();var c=$("body ["+this.avoidstr+"]",this.getDocument());var d=c.not("["+this.avoidstr+"*="+g+"]");var h=c.filter("["+this.avoidstr+"*="+g+"]");d.find("input").attr("disabled",null);d.css("color","inherit");h.find("input").attr("disabled",true);h.css("color","lightgray")}}};a.binding.register("condition",null,null,b)}($axel));(function(a){var b;function d(f,h){try{return f?$.datepicker.formatDate("dd/mm/yy",$.datepicker.parseDate("yy-mm-dd",f)):h}catch(g){return h}}var c={onInstall:function(h){var f=this.getVariable(),g=$("[data-min-date="+f+"]",h.get(0)),e=$("[data-max-date="+f+"]",h.get(0));b=$.datepicker.formatDate("dd/mm/yy",new Date());this.min=a(g.get(0),true);this.max=a(e.get(0),true);this.min.configure("beforeShow",$.proxy(this.beforeShowMinDate,this));this.max.configure("beforeShow",$.proxy(this.beforeShowMaxDate,this));this.max.configure("maxDate",b);g.bind("axel-update",$.proxy(this.minDateChanged,this));e.bind("axel-update",$.proxy(this.maxDateChanged,this))},methods:{beforeShowMinDate:function(e,f){return{maxDate:d(this.max.text(),b)}},beforeShowMaxDate:function(e,f){return{minDate:d(this.min.text(),null)}},minDateChanged:function(g,f){var j,e=b;try{j=$.datepicker.parseDate("dd/mm/yy",f.getData())}catch(i){}try{e=$.datepicker.parseDate("dd/mm/yy",this.max.getData())}catch(h){}if(j&&(j>e)){this.max._setData(f.getData())}},maxDateChanged:function(g,f){var j,e=b;try{j=$.datepicker.parseDate("dd/mm/yy",f.getData())}catch(i){}try{e=$.datepicker.parseDate("dd/mm/yy",this.min.getData())}catch(h){}if(j&&(j<e)){this.min._setData(f.getData())}}}};a.binding.register("interval",null,null,c)}($axel));(function(a){var b={onInstall:function(c){this.re=new RegExp(this.getParam("regexp")||"");this.editor=a(c);c.bind("axel-update",$.proxy(this.checkRegexp,this));a.binding.setValidation(this.editor.get(0),$.proxy(this.checkRegexp,this))},methods:{checkRegexp:function(){var c=this.re.test(this.editor.text());return this.toggleError(c,this.editor.get(0).getHandle(true))}}};a.binding.register("regexp",{error:true},{regexp:a.binding.REQUIRED},b)}($axel));(function(b){var a={onInstall:function(c){this.editors=b(c);this.handle=c.get(0);if(this.handle.xttPrimitiveEditor){xtiger.cross.log("error",'Failed attempt to attach a "required" binding directly onto a primitive editor')}else{this.handle.xttPrimitiveEditor=this}},methods:{isModified:function(){var c=(this.editors.text()!=="");return c},isFocusable:function(){var c=this.editors.get(0);return c?c.isFocusable():false},focus:function(){var c=this.editors.get(0);if(c){this.editors.get(0).focus()}},unfocus:function(){},can:function(c){return false},getHandle:function(){return this.handle},onInit:function(e,c,d){},onAwake:function(){},load:function(d,c){},save:function(c){}}};b.binding.register("required",{error:true},{required:"true"},a)}($axel));(function(a){var b={onInstall:function(c){this.host=c;this.editors=a(c);$('[data-select="'+this.getVariable()+'"]',this.getDocument()).bind("click",$.proxy(this,"execute"))},methods:{execute:function(){this.editors.apply(function(c){if(!c.disabled){c.checked=true}},true);$(this.host).triggerHandler("axel-select-all",[this])}}};a.binding.register("select",null,null,b)}($axel));(function(a){var b={onInstall:function(c){this.editor=a(c);c.bind("axel-update",$.proxy(this.checkSet,this));this.editor.get(0).axel_binding_unique=this;a.binding.setValidation(this.editor.get(0),$.proxy(this.checkOne,this));this.checkSet()},methods:{checkSet:function(m,d){var e,c,h,f,n=$('body [data-binding~="unique"]',this.getDocument()),g=a(n),l=g.values(),k=g.length();for(e=0;e<k;e++){f=0;h=l[e];for(c=0;c<k;c++){if(l[c]===h){if(++f>1){break}}}g.get(e).axel_binding_unique.toggleError((f<=1),g.get(e).getHandle(true))}},checkOne:function(e,g){var j=$('body [data-binding~="unique"]',this.getDocument()),h=this.editor.text(),f=a(j).values(),d=0,c;for(c=0;c<f.length;c++){if(f[c]===h){if(++d>1){break}}}return this.toggleError((d===1),this.editor.get(0).getHandle(true))}}};a.binding.register("unique",{error:true},null,b)}($axel));(function(){function a(e,d,f){var i="width="+d+",height="+f+",status=yes,resizable=yes,scrollbars=yes,title="+e,g;if(xtiger.cross.UA.IE){g=window.open("about:blank")}else{g=window.open(null,e,i)}return g}function c(g){var f=g.replace(/</g,"&lt;");var e=f.replace(/\n/g,"<br/>");var d=e.replace(/ /g,"&nbsp;");return d}function b(d,e){this.key=d;$(e).bind("click",$.proxy(this,"execute"));xtiger.cross.log("debug","installing dump command")}b.prototype={execute:function(f){var e=$axel.command.getEditor(this.key),g,d,h;if(e){prolog='<?xml version="1.0"?>\n';g=e.serializeData();h=a("XML",800,600).document;h.open();h.writeln(c(prolog));h.writeln(c(g));h.close()}}};$axel.command.register("dump",b,{check:true})}());(function(){function a(c,d){var b=$(d);this.label={preview:b.attr("data-preview-label")||b.text(),edit:b.attr("data-edit-label")||"Edit"};b.bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(c){var b=$("body"),d=!b.hasClass("preview");$(c.target).text(this.label[d?"edit":"preview"]);b.toggleClass("preview",d)}};$axel.command.register("preview",a)}());(function(){function a(b,c){this.key=b;$(c).bind("click",$.proxy(this,"execute"))}a.prototype={execute:function(c){var b=$axel.command.getEditor(this.key);if(b){b.reset()}}};$axel.command.register("reset",a,{check:true})}());(function(){function a(b,c,d){this.doc=d||document;this.spec=$(c);this.key=b;this.spec.bind("click",$.proxy(this,"execute"))}a.prototype=(function(){function g(i){return $("error > message",i.responseXML).size()>0}function f(j){var i=$("error > message",j.responseXML).text();return i||j.status}function c(){this.swap.remove();this.fragment.show()}function h(){var i=$axel.command.getEditor(this.key);if(i){i.reset();this.swap.remove();this.fragment.show()}else{$axel.command.logError("Cannot find the document editor to reset",this.errTarget)}}function b(o){var n=o.responseText,j=o.status;var l="Error ! Result code : "+j;var k="";var i=n.match("<title>(.*)</title>","m");if(i){k="\n"+i[1]}i=n.match("<h2>(.*)</h2>","m");if(i){k=k+"\n"+i[1]}else{if($("div.message",o.responseXML).size()>0){k=k+"\n"+$("div.message",o.responseXML).get(0).textContent;if($("div.description",o.responseXML).size()>0){k=k+"\n"+$("div.description",o.responseXML).get(0).textContent}}}return l+k}function e(k,i,n){var m=n.getResponseHeader("Location"),l,j;if(n.status===201){if(m){window.location.href=m}else{l=this.spec.attr("data-replace-type")||"all";j=$("#"+this.spec.attr("data-replace-target"));if(j.length>0){if(l==="all"){j.replaceWith(n.responseText)}else{if(l==="swap"){this.swap=$(n.responseText);j.after(this.swap);j.hide();this.fragment=j;$('button[data-command="continue"]',this.swap).bind("click",$.proxy(c,this));$('button[data-command="reset"]',this.swap).bind("click",$.proxy(h,this))}}}else{xtiger.cross.log("error",'missing "data-replace-target" attribute to report "save" command success')}}}else{$axel.command.logError("Unexpected response from server ("+n.status+"). Save action may have failed",this.errTarget)}}function d(l,i,k){var j;if(i==="timeout"){$axel.command.logError("Save action taking too much time, it has been aborted, however it is possible that your page has been saved",this.errTarget)}else{if(l.status===409){j=l.getResponseHeader("Location");if(j){window.location.href=j}else{$axel.command.logError(f(l),this.errTarget)}}else{if(g(l)){$axel.command.logError(f(l),this.errTarget)}else{if(l.responseText.search("Error</title>")!==-1){$axel.command.logError(b(l),this.errTarget)}else{if(k){$axel.command.logError("Exception : "+k.name+" / "+k.message+"\n (line "+k.lineNumber+")",this.errTarget)}else{$axel.command.logError('Error while connecting to "'+this.url+'" ('+l.status+")",this.errTarget)}}}}}}return{execute:function(k){var o=$axel.command.getEditor(this.key),j=true,i,p,l,m,q,n;if(o){url=o.attr("data-src")||this.spec.attr("data-src")||".";if(url){if(o.attr("data-validation")){n=$axel(o.spec.get(0));j=$axel.binding.validate(n,o.attr("data-validation"),this.doc)}if(j){m=o.serializeData();if(m){i=o.attr("data-method")||this.spec.attr("data-method")||"post";l=o.attr("data-transaction")||this.spec.attr("data-transaction");if(l){url=url+"?transaction="+l}$.ajax({url:url,type:i,data:m,dataType:"xml",cache:false,timeout:10000,contentType:"application/xml; charset=UTF-8",success:$.proxy(e,this),error:$.proxy(d,this)});o.hasBeenSaved=true}else{$axel.command.logError("The editor did not generate any data")}}}else{$axel.command.logError("The command does not know where to send the data")}}else{$axel.command.logError("There is no editor associated with this command")}}}}());$axel.command.register("save",a,{check:true})}());(function(){function a(c,d){var b=$(d);this.key=c;this.formid=b.attr("data-form");if(this.formid&&($("form#"+this.formid).length>0)){d.disabled=false;b.bind("click",$.proxy(this,"execute"))}else{d.disabled=true;$axel.command.logError('Missing or invalid data-form attribute in submit command ("'+this.formid+'")')}}a.prototype={execute:function(){var c=$("#"+this.formid),e=$("#"+this.formid+' > input[name="data"]'),b=$axel.command.getEditor(this.key);if(b&&(c.length>0)&&(e.length>0)){e.val(b.serializeData());c.submit()}else{$axel.command.logError("Missing editor or malformed form element to submit data")}}};$axel.command.register("submit",a,{check:true})}());(function(){function a(b,d,e){var c=$(d);this.doc=e;this.key=b;this.errid=c.attr("data-validation");if(this.errid){c.bind("click",$.proxy(this,"execute"))}else{xtiger.cross.log("error",'Missing "data-validation" attribute in "validation" command')}}a.prototype={execute:function(d){var c,b=$axel.command.getEditor(this.key);if(b){fields=$axel(b.spec.get(0));$axel.binding.validate(fields,this.errid,this.doc)}}};$axel.command.register("validate",a,{check:true})}());